<!DOCTYPE html><html lang="zh-cmn-Hans"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"/><style data-href="/app.3290113900e6c74c2b6d.css">code[class*=language-],pre[class*=language-]{color:#fff;background:none;font-family:Consolas,Menlo,Monaco,source-code-pro,Courier New,monospace;-webkit-font-feature-settings:normal;font-feature-settings:normal;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;margin-bottom:0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{overflow:auto;padding:1em}pre[class*=language-]::selection{background:#27292a}pre[class*=language-]::selection,pre[class*=language-] ::selection{text-shadow:none;background:hsla(0,0%,100%,.15)}:not(pre)>code[class*=language-]{border-radius:.3em;background:rgba(255,229,100,.2);color:#1a1a1a;padding:.15em .2em .05em;white-space:normal}.token.attr-name{color:#addb67;font-style:italic}.token.comment{color:#637777}.token.string,.token.url{color:#addb67}.token.variable{color:#d6deeb}.token.number{color:#f78c6c}.token.builtin,.token.char,.token.constant,.token.function{color:#82aaff}.token.punctuation{color:#c792ea}.token.doctype,.token.selector{color:#c792ea;font-style:"italic"}.token.class-name{color:#ffcb8b}.token.keyword,.token.operator,.token.tag{color:#ffa7c4}.token.boolean{color:#ff5874}.token.property{color:#80cbc4}.token.namespace{color:#b2ccd6}pre[data-line]{padding:1em 0 1em 3em;position:relative}.gatsby-highlight-code-line{background-color:#022a4b;display:block;margin-right:-1em;margin-left:-1em;padding-right:1em;padding-left:.75em;border-left:.25em solid #ffa7c4}.gatsby-highlight{margin-bottom:1.75rem;border-radius:10px;background:#011627;-webkit-overflow-scrolling:touch;overflow:auto}.gatsby-highlight pre[class*=language-]{float:left;min-width:100%}.katex .katex-mathml{border:0;clip:rect(1px,1px,1px,1px);height:1px;overflow:hidden;padding:0;position:absolute;width:1px}.license{display:flex;align-items:center;font-size:.8rem}.license>a{display:inline-block;box-shadow:none;height:31px;flex-shrink:0}.license>div{margin-left:10px}</style><meta name="generator" content="Gatsby 2.0.76"/><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-31656866-1', 'auto', {});
      
      }
      </script><link rel="alternate" type="application/rss+xml" title="LaySent&#x27;s Blog" href="/blog/rss.xml"/><link rel="shortcut icon" href="/icons/icon-48x48.png"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#007acc"/><title data-react-helmet="true">Android App 逆向工程初探 | LaySent&#x27;s Site</title><link data-react-helmet="true" href="https://laysent.github.io/blog/post/android-app-reverse-engineering-tutorial/" rel="canonical"/><meta data-react-helmet="true" name="description" content="这篇文章主要讲关于如何逆向某 Android 程序，并找到网络请求中 querstring 里 signature 计算方法的过程"/><meta data-react-helmet="true" property="og:title" content="Android App 逆向工程初探"/><meta data-react-helmet="true" property="og:description" content="这篇文章主要讲关于如何逆向某 Android 程序，并找到网络请求中 querstring 里 signature 计算方法的过程"/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator" content="LaySent"/><meta data-react-helmet="true" name="twitter:title" content="Android App 逆向工程初探"/><meta data-react-helmet="true" name="twitter:description" content="这篇文章主要讲关于如何逆向某 Android 程序，并找到网络请求中 querstring 里 signature 计算方法的过程"/><style id="typography.js">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:100%/1.75 'Rubik',-apple-system,'BlinkMacSystemFont','PingFang SC','Segoe UI','Roboto','Oxygen','Ubuntu','Cantarell','Fira Sans','Droid Sans','Helvetica Neue','Helvetica','Arial','Hiragino Sans GB','Microsoft Yahei','WenQuanYi Micro Hei',sans-serif;box-sizing:border-box;overflow-y:scroll;}*{box-sizing:inherit;}*:before{box-sizing:inherit;}*:after{box-sizing:inherit;}body{color:hsla(0,0%,0%,0.9);font-family:'Rubik',-apple-system,'BlinkMacSystemFont','PingFang SC','Segoe UI','Roboto','Oxygen','Ubuntu','Cantarell','Fira Sans','Droid Sans','Helvetica Neue','Helvetica','Arial','Hiragino Sans GB','Microsoft Yahei','WenQuanYi Micro Hei',sans-serif;font-weight:400;word-wrap:break-word;font-kerning:normal;-moz-font-feature-settings:"kern", "liga", "clig", "calt";-ms-font-feature-settings:"kern", "liga", "clig", "calt";-webkit-font-feature-settings:"kern", "liga", "clig", "calt";font-feature-settings:"kern", "liga", "clig", "calt";}img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}h1{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:"Rubik","-apple-system","BlinkMacSystemFont","PingFang SC","Segoe UI","Roboto","Oxygen","Ubuntu","Cantarell","Fira Sans","Droid Sans","Helvetica Neue","Helvetica","Arial","Hiragino Sans GB","Microsoft Yahei","WenQuanYi Micro Hei","sans-serif";font-weight:900;text-rendering:optimizeLegibility;font-size:2.5rem;line-height:1.1;}h2{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Rubik',-apple-system,'BlinkMacSystemFont','PingFang SC','Segoe UI','Roboto','Oxygen','Ubuntu','Cantarell','Fira Sans','Droid Sans','Helvetica Neue','Helvetica','Arial','Hiragino Sans GB','Microsoft Yahei','WenQuanYi Micro Hei',sans-serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1.73286rem;line-height:1.1;}h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Rubik',-apple-system,'BlinkMacSystemFont','PingFang SC','Segoe UI','Roboto','Oxygen','Ubuntu','Cantarell','Fira Sans','Droid Sans','Helvetica Neue','Helvetica','Arial','Hiragino Sans GB','Microsoft Yahei','WenQuanYi Micro Hei',sans-serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1.4427rem;line-height:1.1;}h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Rubik',-apple-system,'BlinkMacSystemFont','PingFang SC','Segoe UI','Roboto','Oxygen','Ubuntu','Cantarell','Fira Sans','Droid Sans','Helvetica Neue','Helvetica','Arial','Hiragino Sans GB','Microsoft Yahei','WenQuanYi Micro Hei',sans-serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.1;letter-spacing:0.140625em;text-transform:uppercase;}h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Rubik',-apple-system,'BlinkMacSystemFont','PingFang SC','Segoe UI','Roboto','Oxygen','Ubuntu','Cantarell','Fira Sans','Droid Sans','Helvetica Neue','Helvetica','Arial','Hiragino Sans GB','Microsoft Yahei','WenQuanYi Micro Hei',sans-serif;font-weight:900;text-rendering:optimizeLegibility;font-size:0.83255rem;line-height:1.1;}h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Rubik',-apple-system,'BlinkMacSystemFont','PingFang SC','Segoe UI','Roboto','Oxygen','Ubuntu','Cantarell','Fira Sans','Droid Sans','Helvetica Neue','Helvetica','Arial','Hiragino Sans GB','Microsoft Yahei','WenQuanYi Micro Hei',sans-serif;font-weight:900;text-rendering:optimizeLegibility;font-size:0.75966rem;line-height:1.1;font-style:italic;}hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}ul{margin-left:1.75rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;list-style-position:outside;list-style-image:none;list-style:disc;}ol{margin-left:1.75rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;list-style-position:outside;list-style-image:none;}dl{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}p{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:0.85rem;line-height:1.75rem;}table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:1rem;line-height:1.75rem;border-collapse:collapse;width:100%;}fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}blockquote{margin-left:-1.75rem;margin-right:1.75rem;margin-top:0;padding-bottom:0;padding-left:1.42188rem;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:1.20112rem;line-height:1.75rem;color:hsla(0,0%,0%,0.59);font-style:italic;border-left:0.32813rem solid hsla(0,0%,0%,0.9);}form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(1.75rem - 1px);background:hsla(0,0%,0%,0.2);border:none;height:1px;}address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}b{font-weight:700;}strong{font-weight:700;}dt{font-weight:700;}th{font-weight:700;}li{margin-bottom:calc(1.75rem / 2);}ol li{padding-left:0;}ul li{padding-left:0;}li > ol{margin-left:1.75rem;margin-bottom:calc(1.75rem / 2);margin-top:calc(1.75rem / 2);}li > ul{margin-left:1.75rem;margin-bottom:calc(1.75rem / 2);margin-top:calc(1.75rem / 2);}blockquote *:last-child{margin-bottom:0;}li *:last-child{margin-bottom:0;}p *:last-child{margin-bottom:0;}li > p{margin-bottom:calc(1.75rem / 2);}code{font-size:0.85rem;line-height:1.75rem;}kbd{font-size:0.85rem;line-height:1.75rem;}samp{font-size:0.85rem;line-height:1.75rem;}abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}thead{text-align:left;}td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding-left:1.16667rem;padding-right:1.16667rem;padding-top:0.875rem;padding-bottom:calc(0.875rem - 1px);}th:first-child,td:first-child{padding-left:0;}th:last-child,td:last-child{padding-right:0;}blockquote > :last-child{margin-bottom:0;}blockquote cite{font-size:1rem;line-height:1.75rem;color:hsla(0,0%,0%,0.9);font-weight:400;}blockquote cite:before{content:"— ";}ul,ol{margin-left:0;}@media only screen and (max-width:480px){ul,ol{margin-left:1.75rem;}blockquote{margin-left:-1.3125rem;margin-right:0;padding-left:0.98438rem;}}h1,h2,h3,h4,h5,h6{margin-top:3.5rem;}a{box-shadow:0 1px 0 0 currentColor;color:#007acc;text-decoration:none;}a:hover,a:active{box-shadow:none;}mark,ins{background:#007acc;color:white;padding:0.10938rem 0.21875rem;text-decoration:none;}a.gatsby-resp-image-link{box-shadow:none;}</style><link href="//fonts.googleapis.com/css?family=Rubik:300,400,500" rel="stylesheet" type="text/css"/><link as="script" rel="preload" href="/component---src-templates-blog-post-js-d31bd3902e603f920671.js"/><link as="script" rel="preload" href="/0-05a468e8ca35df48296c.js"/><link as="script" rel="preload" href="/app-ecc524f4dcfa31ef9426.js"/><link as="script" rel="preload" href="/webpack-runtime-affded7bd860e9973444.js"/><link as="fetch" rel="preload" href="/static/d/110/path---blog-post-android-app-reverse-engineering-tutorial-f-83-751-F4TzcM2CpSEPWxeDYR9pP14dQ.json" crossOrigin="use-credentials"/></head><body><noscript>Notice: You need to enable JavaScript to enable all functionality in this blog.</noscript><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group"><main style="margin-left:auto;margin-right:auto;max-width:49rem;padding:2.625rem 1.3125rem" itemscope="" itemType="http://schema.org/Blog"><nav><h3 style="margin-top:0"><a style="box-shadow:none;text-decoration:none;color:inherit" href="/blog/">LaySent&#x27;s Blog</a></h3></nav><article itemscope="" itemType="http://schema.org/BlogPosting"><header><h1 itemProp="headline">Android App 逆向工程初探</h1><p style="font-size:0.83255rem;line-height:1.75rem;display:block;margin-bottom:1.75rem;margin-top:-1.75rem"><time itemProp="datePublished" dateTime="2019-01-20">2019-01-20</time><span> • (modified: <time itemProp="dateModified" dateTime="2019-03-11">2019-03-11</time>)</span><span itemscope="" itemType="http://schema.org/Person" itemProp="author"> • by <span itemProp="name">LaySent</span></span></p></header><div itemProp="articleBody"><section><h2>背景</h2><p>这次研究的出发点，是希望可以了解某服务提供商 API 的调用规则，从而可以写一个定制化的服务为个人所用。</p><p>通过前期的研究，发现这里的网络请求主要是通过一个 signature 参数对请求的有效性进行验证。如果参数重的 signature 的值不正确，服务器将拒绝返回任何数据。由于网络请求本身对外是透明的，服务提供方为了防止 API 被第三方滥用，往往需要使用各种方法来校验有效性。这个 App 可以在免注册的情况下直接使用，故而一般的账户校验无法进行。这里 signature 是如何计算出来的，服务器又是如何通过校验确认合法性的，是本次研究主要好奇的地方。</p><p>本文主要是一些技术尝试的记录，下文中将不提及具体的 App 名称，以免造成不必要的麻烦。</p></section>
<section><h2>前期准备</h2><p>Android 逆向主要需要用到以下一些工具</p><ul>
<li>apktool: <a href="https://github.com/iBotPeaches/Apktool">GitHub</a>，<a href="https://bitbucket.org/iBotPeaches/apktool/downloads/">下载地址</a>，可以将 .apk 文件解码</li>
<li>smali: <a href="https://github.com/JesusFreke/smali">GitHub</a>，<a href="https://bitbucket.org/JesusFreke/smali/downloads/">下载地址</a>，可以将 .smali 文件打包成 .dex 文件</li>
<li>ByteCode-Viewer: <a href="https://github.com/Konloch/bytecode-viewer/">GitHub</a>，<a href="https://github.com/Konloch/bytecode-viewer/releases">下载地址</a>，可以直接阅读 .dex 文件中的 Java 代码</li>
</ul><p>当然，还需要 Android App 的 .apk 安装文件。这个可以从各大 Android App 平台下载到，或者也可以从各 App 的官网找到对应 .apk 的下载地址。</p></section>
<section><h2>分析步骤</h2><section><h3>apk => smali</h3><p>首先，需要使用 apktool 对拿到的 .apk 文件进行解码：</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">./apktool d xxx.apk -o xxx</code></pre></div><p>上述命令，将 xxx.apk 文件反编译到 xxx 文件夹内。通过观察解码的结果可以发现，资源文件、配置文件以及代码都被解码出来了。其中，代码部分并不是 java 源码，而是 smali 格式的文件。</p><blockquote>
<p>在执行 Android Java 层的代码时，其实就是 Dalvik(ART) 虚拟机（使用 C 或 C++ 代码实现）在解析 Dalvik 字节码，从而模拟程序的执行过程。</p>
<p>自然，Dalvik 字节码晦涩难懂，研究人员们给出了 Dalvik 字节码的一种助记方式：smali 语法。通过一些工具（如 apktool），我们可以把已有的 dex 文件转化为若干个 smali 文件（一般而言，一个 smali 文件对应着一个类），然后进行阅读。对于不同的工具来说，其转换后的 smali 代码一般都不一样，毕竟这个语法不是官方的标准。这里我们介绍比较通用的语法。值得注意的是，在 smali 语法中，使用的都是寄存器，但是其在解释执行的时候，很多都会映射到栈中。</p>
<p><a href="https://ctf-wiki.github.io/ctf-wiki/android/basic_operating_mechanism/java_layer/smali/smali/">来源</a></p>
</blockquote><p>有了 smali 文件之后，其实已经可以开始初步的代码阅读了。</p></section><section><h3>smali => dex</h3><p>在 smali 语言不熟悉的情况下，可以借助 smali 工具将文件转化为 dex 文件，并通过 ByteCode-Viewer 来阅读 Java 的代码。具体操作如下：</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">java -jar ./smali-2.2.5.jar a xxx.smali yyy.smali zzz.smali</code></pre></div><p>这里，可以一次性将一批 smali 文件打包为一个 out.dex 文件。编译出这个结果之后，可以通过 ByteCode-Viewer 打开直接阅读 Java 源码。如果 Android App 的打包包含了混淆，那么最终这里生成的代码结果，函数/变量名很可能是难以读懂的 a、b、c，编译的结果可能有一些错误。总体而言，可以将这个结果和 smali 本身的结果配合使用，方便了解代码的本意。</p></section></section>
<section><h2>具体分析</h2><p>逆向的分析，可以从非代码层面开始着手。</p><p>以这个 App 为例，通过使用 anyproxy 代理网络请求，可以抓取到具体使用的网络请求 API 地址。通过观察发现，不管是什么样的 API 请求，在 URL 的查询参数中，都有几个固定的参数，一个是 timestamp，一个是 signature。通过修改 URL 查询参数的数据不难发现，无论修改参数中的哪个值，都会导致请求直接失败。由此，不难得出初步的结论，signature 的值是通过 URL 查询参数中的其他值计算出来的，并且由于存在 timestamp 这个参数，导致这个计算结果无法缓存。如果不能找到 signature 的具体计算方法，就无法成功模拟调用 API 成功。</p><p>同时，下面列出了几个抓取到的 signature 的值：</p><ul>
<li>QeVgI1CAbvkwCR9jdrioSz6BGbZg1tcaXWvokGk6OkU%3D</li>
<li>45k4t1vIzqf%2F5MiERLO4M3WKzl27pT2iXRfgpwohUiA%3D</li>
</ul><p>不难看出，这里的 %2F 以及 %3D 是 URL 编码后的结果。而编码前的值，很可能是 sha256 加密后的结果（因为和 Subresource Integrity 的结果形似，SRI 相关的介绍可以看<a href="https://laysent.github.io/blog/subresource-integrity/">这里</a>）。</p><p>有了以上的初步分析结果，就可以开始正式的代码分析了。一般来说，Android App 由于 apk 很容易获取到，所以发布之前都会经过代码的混淆操作。这里分析的 App 也不例外。如果直接查看 smali 的解码结果，不难发现很多 a、b、c 之类的函数/变量名，很难直观的了解具体到底函数/类是在进行什么样的操作。然而，从前端的经验来说，虽然函数名/变量名很容易进行混淆，但是字符串本身却很少会进行混淆的操作。有了上面关于 URL 参数的分析，可以很容易想到，先通过搜索对应的 URL 参数字符串，找到相关的代码，然后再对具体的内容进行分析。</p><p>在抓取到的 URL 参数中，可以发现不少固定的参数，比如上文提到的 signature，timestamp，还有 uuid、appSource 等值。既然猜测 signature 的计算需要用到其他的 URL 参数，那么不妨试着在 smali 代码中搜索 signature 字符串，并找到同时使用到 uuid 或者 appSource 或者 timestamp 的位置。</p><p>很快，通过交叉对比，就有两个文件脱颖而出，分别是：</p><ul>
<li>smali_classes2/com/xxx/yyy/net/a.smali</li>
<li>smali_classes2/com/xxx/yyy/net/retrofit/b/a.smali</li>
</ul><p>其中，这里的 retrofit 是 Java 中使用到的一个 HTTP 请求库。同时，从文件路径的 net 不难猜测，这两个文件都是和网络请求相关的，很可能和具体计算 signature 的逻辑相关。</p><p>来看其中的第一个文件。</p><p>由于 smali 的代码比较冗长，这里给出经过 smali 工具解析后的 Java 代码：</p><div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">a</span><span class="token punctuation">(</span>Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> String<span class="token punctuation">></span></span> paramMap<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>paramMap<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token string">"uuid"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    paramMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"uuid"</span><span class="token punctuation">,</span> i<span class="token punctuation">.</span><span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>paramMap<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token string">"access_id"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    paramMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"access_id"</span><span class="token punctuation">,</span> <span class="token string">"ptapp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>paramMap<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token string">"timestamp"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 这里的 timestamp 就是一个 ms 计算的时间，和 JavaScript 中的 Date.now() 值相同
     */</span>
    StringBuilder localStringBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    localStringBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    localStringBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    paramMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"timestamp"</span><span class="token punctuation">,</span> localStringBuilder<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>paramMap<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token string">"city"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    paramMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"city"</span><span class="token punctuation">,</span> c<span class="token punctuation">.</span><span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>paramMap<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token string">"token"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 从实际的使用上来看，URL 中的 token 并没有提供具体的值，可以猜测这个函数会提供一个 token 值，
     * 而第二个参数的空字符串就是当 token 未找到情况下（即未登录）的默认值
     */</span>
    paramMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"token"</span><span class="token punctuation">,</span> ac<span class="token punctuation">.</span><span class="token function">b</span><span class="token punctuation">(</span><span class="token string">"user_token"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>paramMap<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token string">"appSource"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    paramMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"appSource"</span><span class="token punctuation">,</span> BaseApplication<span class="token punctuation">.</span><span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>paramMap<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token string">"platform"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    paramMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"platform"</span><span class="token punctuation">,</span> <span class="token string">"Android"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/**
   * 不难发现，这里的 k.b(k.a("POST", paramMap)) 就是计算 signature 的具体过程，
   */</span>
<span class="gatsby-highlight-code-line">  String str <span class="token operator">=</span> k<span class="token punctuation">.</span><span class="token function">b</span><span class="token punctuation">(</span>k<span class="token punctuation">.</span><span class="token function">a</span><span class="token punctuation">(</span><span class="token string">"POST"</span><span class="token punctuation">,</span> paramMap<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>paramMap<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token string">"signature"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    paramMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"signature"</span><span class="token punctuation">,</span> str<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div><p>通过查找 smali 对应的代码，不难发现，这里的 <code class="language-text">String str = k.b(k.a(&quot;POST&quot;, paramMap));</code> 对应的代码为：</p><div class="gatsby-highlight" data-language="smali"><pre class="language-smali"><code class="language-smali">:cond_6
const-string v0, &quot;POST&quot;

.line 48
invoke-static {v0, p0}, Lcom/xxx/yyy/utils/k;-&gt;a(Ljava/lang/String;Ljava/util/Map;)Ljava/lang/String;

move-result-object v0

.line 49
invoke-static {v0}, Lcom/xxx/yyy/utils/k;-&gt;b(Ljava/lang/String;)Ljava/lang/String;

move-result-object v0</code></pre></div><p>也即使说，分别对应的是 xxx/yyy/utils/k.smali 类中定义的 a 和 b 两个静态方法。</p><p>现在来查看 xxx/yyy/utils/k.smali 中的文件，同样出于长度的考虑，这里给出经过工具解析的 Java 代码：</p><div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java"><span class="token comment">/**
 * 这个函数的工作非常明显，就是讲字符串进行 URL 编码
 * 编码的效果基本等同于 encodeURLComponent，不同在于后面的那几个字符的替换
 */</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> String <span class="token function">a</span><span class="token punctuation">(</span>String paramString<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>paramString <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span>
    <span class="token punctuation">{</span>
      String str <span class="token operator">=</span> URLEncoder
        <span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>paramString<span class="token punctuation">,</span> <span class="token string">"UTF-8"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"+"</span><span class="token punctuation">,</span> <span class="token string">"%20"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"*"</span><span class="token punctuation">,</span> <span class="token string">"%2A"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"%7E"</span><span class="token punctuation">,</span> <span class="token string">"~"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> str<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">UnsupportedEncodingException</span> localUnsupportedEncodingException<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      localUnsupportedEncodingException<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> paramString<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> null<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
 * 这个函数的作用，就是将 paramMap 这个函数中的值，拼接成一个字符串
 * 拼接的结果是 `${paramString}&amp;%2F&amp;${key1}%3D${value1}%26${key2}%3D${value2}`
 * 当然，这里的 key 和 value 都是经过了上面函数进行 URL 编码的
 * 具体的代码如下
 */</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> String <span class="token function">a</span><span class="token punctuation">(</span>String paramString<span class="token punctuation">,</span> Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> String<span class="token punctuation">></span></span> paramMap<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  Set keySet <span class="token operator">=</span> paramMap<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment">// 按 key 进行排序</span>
  String<span class="token punctuation">[</span><span class="token punctuation">]</span> keys <span class="token operator">=</span> <span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>keySet<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Arrays<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>keys<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 拼接字符串</span>
  StringBuilder result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  result<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>paramString<span class="token punctuation">)</span><span class="token punctuation">;</span>
  result<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"&amp;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 不编码的 &amp;</span>
  <span class="token comment">// 这里的 a 函数，就是上面的那个静态方法，是同一个函数的不同重载</span>
  result<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token function">a</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  result<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"&amp;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 不编码的 &amp;</span>
  StringBuilder params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> j <span class="token operator">=</span> keys<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> j<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    String key <span class="token operator">=</span> keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    params<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"&amp;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    params<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token function">a</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    params<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    params<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">(</span>String<span class="token punctuation">)</span>paramMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    i<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/**
   * 这里的 subString(1) 主要是去掉了开头的 &amp;
   * 也就是说，这里的前两个 &amp; 是部编码的
   * 但是之后的每一 key/value 对连接处用到的 &amp; 都是编码成 %2F 了，同样 = 也编码成了 %3D
   */</span>
  result<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token function">a</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> result<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
 * 这里是加密的函数，使用 HmacSHA256 进行加密
 * 用到了一个密钥，密钥的主体部分通过 a.b().s() 获取
 */</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> String <span class="token function">b</span><span class="token punctuation">(</span>String paramString<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token comment">// 这里获取到了加密使用的密钥</span>
  StringBuilder keyBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="gatsby-highlight-code-line">  keyBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">s</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>  keyBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"&amp;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  String key <span class="token operator">=</span> keyBuilder<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span>
  <span class="token punctuation">{</span>
    Mac localMac <span class="token operator">=</span> Mac<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">"HmacSHA256"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    localMac<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SecretKeySpec</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"HmacSHA256"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>
      Base64<span class="token punctuation">.</span><span class="token function">encodeBase64</span><span class="token punctuation">(</span>localMac<span class="token punctuation">.</span><span class="token function">doFinal</span><span class="token punctuation">(</span>paramString<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> localException<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    localException<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> paramString<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div><p>这里，主要需要知道的，就是静态方法 b 中的 <code class="language-text">a.b().s()</code> 函数究竟是返回了什么样的密钥。有了这个密钥之后，就可以根据 URL 来计算出正确的 signature 了。这里，<code class="language-text">a.b()</code> 对应的 smali 代码为：</p><div class="gatsby-highlight" data-language="smali"><pre class="language-smali"><code class="language-smali">.method public static b()Lcom/xxx/yyy/manager/a;
    .locals 1

    .line 91
    invoke-static {}, Lcom/xxx/yyy/manager/a$a;-&gt;a()Lcom/xxx/yyy/manager/a;

    move-result-object v0

    return-object v0
.end method</code></pre></div><p>而 <code class="language-text">a$a.a()</code> 对应的 smali 代码为：</p><div class="gatsby-highlight" data-language="smali"><pre class="language-smali"><code class="language-smali">.field private static final a:Lcom/xxx/yyy/manager/a;
.method static synthetic a()Lcom/xxx/yyy/manager/a;
    .locals 1

    .line 94
    sget-object v0, Lcom/xxx/yyy/manager/a$a;-&gt;a:Lcom/xxx/yyy/manager/a;

    return-object v0
.end method</code></pre></div><p>不难看出，最开始 <code class="language-text">a.b()</code> 的代码，其实就是一个 Singleton 返回了一个 <code class="language-text">a</code> 类型的对象而已。那么 <code class="language-text">a.b().s()</code> 代码，就只需要找到 <code class="language-text">a</code> 类型的 <code class="language-text">s</code> 方法就可以了，在 <code class="language-text">a.smali</code> 中，可以找到代码如下：</p><div class="gatsby-highlight" data-language="smali"><pre class="language-smali"><code class="language-smali">.method public s()Ljava/lang/String;
    .locals 1

    .line 219
    iget-object v0, p0, Lcom/xxx/yyy/manager/a;-&gt;b:Lcom/xxx/yyy/b/i;

    invoke-interface {v0}, Lcom/xxx/yyy/b/i;-&gt;k()Ljava/lang/String;

    move-result-object v0

    return-object v0
.end method</code></pre></div><p>可以等价写成 Java 代码：</p><div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java"><span class="token keyword">public</span> String <span class="token function">s</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>b<span class="token punctuation">.</span><span class="token function">k</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div><p>这里，可以去 <code class="language-text">a</code> 的构造函数中去寻找 <code class="language-text">this.b</code> 的具体定义方式。同时，从 smali 中也不难知道，这里的 <code class="language-text">this.b</code> 是一个定义在 <code class="language-text">com/xxx/yyy/b/i.smali</code> 中的类对象。直接去该文件中看，不难发现这个 <code class="language-text">i</code> 定义为 <code class="language-text">.class public interface abstract Lcom/xxx/yyy/b/i;</code>。那么，既然是一个 interface，接下来只要搜索哪些类实现了这个 interface 就可以了。搜索 <code class="language-text">.implements Lcom/xxx/yyy/b/i;</code> 不难发现，实现的类，主要就是同目录下的 <code class="language-text">a.smali</code>，<code class="language-text">e.smali</code> 和 <code class="language-text">j.smali</code>。在任意一个具体实现的类中，都可以找到这个 <code class="language-text">k</code> 方法的实现。</p><div class="gatsby-highlight" data-language="smali"><pre class="language-smali"><code class="language-smali">.method public k()Ljava/lang/String;
    .locals 1

    const-string v0, &quot;xxx&quot;

    return-object v0
.end method</code></pre></div><p>这里的 xxx 就是具体的密钥值。</p><p>当然，上面如果直接从 <code class="language-text">a</code> 的构造函数中去寻找 <code class="language-text">this.b</code>，也同样指向到了同目录下的 <code class="language-text">g.smali</code>，<code class="language-text">c.smali</code> 等文件，这些分别是上面 <code class="language-text">a.smali</code>，<code class="language-text">e.smali</code> 和 <code class="language-text">j.smali</code> 的子类。具体 <code class="language-text">k</code> 方法的定义，依然在这三个父类中。</p><p>至此，整个 signature 的计算过程基本明朗了。</p><p>然而，这只是第一个文件的解析结果。对于第二个出现 signature 字符串的文件，也可以用类似的思路进行分析。最后发现，真正加密的部分，依然落到了上面提到的那个加密函数中，连拼接字符串的部分也是一样的。唯一不同的是，提供的第一个参数不再是 POST，而是一个函数调用后的结果。这里猜测具体的函数返回结果，就是当前 HTTP 请求的类型，不是 GET 就是 POST。经过测试，也确实如此。故，这部分分析就省略了。</p></section>
<section><h2>结果</h2><p>根据以上的分析结果，可以把这部分对应的 Java 代码用 JavaScript 再写一遍：</p><div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'crypto'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> key <span class="token operator">=</span> <span class="token string">'xxx'</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">encode</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\+/g</span><span class="token punctuation">,</span> <span class="token string">'%20'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\*/g</span><span class="token punctuation">,</span> <span class="token string">'%2A'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/%7E/g</span><span class="token punctuation">,</span> <span class="token string">'~'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">getStringForEncrypt</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> parsed <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
  parsed<span class="token punctuation">.</span>searchParams<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> ending <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token keyword">from</span><span class="token punctuation">(</span>parsed<span class="token punctuation">.</span>searchParams<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span>acc<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// 去掉抓取 URL 中自带的 signature 值</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">'signature'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> acc<span class="token punctuation">;</span>
    <span class="token keyword">let</span> value <span class="token operator">=</span> parsed<span class="token punctuation">.</span>searchParams<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    acc <span class="token operator">+=</span> <span class="token template-string"><span class="token string">`&amp;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">encode</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">encode</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> acc<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>method<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">encode</span><span class="token punctuation">(</span>ending<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">encrypt</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> hmac <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createHmac</span><span class="token punctuation">(</span><span class="token string">'sha256'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> hmac<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">'base64'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token string">'代理抓取到的 URL 请求地址'</span><span class="token punctuation">;</span>
<span class="token comment">// 这里将输出计算后的 signature 值，可以和抓取到的值比较验证</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'signature: '</span><span class="token punctuation">,</span> <span class="token function">encrypt</span><span class="token punctuation">(</span><span class="token function">getStringForEncrypt</span><span class="token punctuation">(</span><span class="token string">'GET'</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div></section>
<section><h2>总结</h2><p>总体来说，带着具体的目的去逆向 Android App 并不会特别的困难。中间考虑的太复杂，反而饶了一些弯路。实践下来，从字符串进行切入之后，广度优先遍历搜索会比深度优先遍历搜索来得更有效果一些。深度优先的阅读顺序，容易陷入到代码的细节中，考虑太多调用/被调用方的具体逻辑。广度优先的阅读策略，更容易把握全局的思路，找到真正的突破口。</p><p>最后，逆向是一个非常考验耐心的工程。随时记录已经阅读过/思考过的部分，有助于提高效率。</p></section></div><hr style="margin-bottom:1.75rem"/><footer><div class="license" style="margin-bottom:1.75rem;font-size:0.875rem"><a rel="license noopener noreferrer" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank"><img alt="Creative Commons License" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFgAAAAfCAMAAABUFvrSAAAABGdBTUEAALGOfPtRkwAAACBjSFJNAAB6JQAAgIMAAPn/AACA6QAAdTAAAOpgAAA6mAAAF2+SX8VGAAABuVBMVEX///////////8AAAC1urS3vLa5vri8wbu+w77BxcDDyMPGysXIzMfJzcnLzsrMz8vM0MzLz8rKzcnEyMO/w765vrmzuLKxt7Cwta+utK2ts6yssqursaq6v7m9wrzAxL/Dx8LJzcjO0c3Q08/R1NDS1dLT1tLR1NHLz8vAxb+vta7AxcDHy8eEhYRDREMNDg2EhoTO0s7EycS9wr2yuLGwtq+us615fHkpKSnM0MuRk5EbGxuRlJHFycS0ubOyt7GTmJMoKShAQEBwcHBQUVAQEBBgYGCAgIC/v7/Ex8PN0cy2u7Wfo54ODg5QUFDf39/////v7++fn5+7wLq4vbeRj49aV1gwMDCxtrCvtK7W1dUyMTGamJkZGRkNDA12c3Tj4+PIzMi/xL60urMoJSYjHyA/OzxoZWaHhoesq6vPz8+8wbx1cnN4dXbN0c2+wr3Ix8fP08+Pj48xLS66ubmvr6+7wLvx8fGenZ3S1dEgICB+e3wfGxzGysaEgYKMiou6v7rCx8LFycWeoJ18f3xdXl2ChYJwcm/Q1NA1NjV9f3zN0MyWmZYyMzGvsq+ws68+Pz6JjIm8wLzsYHBTAAAAA3RSTlMADgqEIABOAAAAAWJLR0QAiAUdSAAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB+IHHgQ0GU32H34AAAN/SURBVEjHtZaLX9JQFMepIyBuDhDNFDVgE5MKylJeljGE0UO4UEHRA3pgaaWVWUnvh9k76y/ubAPcxvBT9PF+2OfCb7vfnfu7556LYRfsSDMYADqMJnOnpYuiuxmrzWa199CUw9Jr7jN27OnfOzA46Bz694Zk5A6P7HNRbruH5Ua93tEx1rPfTbnGR4ZFsm9g0NkW2QDIPeA4yHi4Q/6AOImA/zB3xE5PWI4i+dikb6oecjAk3g4FtQxdHcEm5NJhNhLdMig6zdrcxy0jfcYTM5O1kE/GAPh4nAeInVQSWugINu9z0DZuFnmJpJBKCckEfp09ddo9MW42nUEzpJDPzkE6Q7Bl0jCnILTSEdzpOhgWuQkhS+SWQ3TslI129Z473yGFPDQUgyTeARBvQ2wLIOsX8lodwRaKYZFbyJBGyxYwZtZOWUYw5IuX0IsgpIt1MElDw88gXL6C3KvXSmWVLoK7rnsiyM0SoiZPH3E7bpwz3pzxTTmdIVC8NwOh+vgQ3KrM3wbhDiyodBFM2bkoJBaJqmUTEOX2U5a7JkwM9AJ4UU2CNHHCQ2M8f+9+pVIplYtqXQTTS4cABKJpOYDDHtq1PIxeiOA4kZyQvYhvgVF/UEK5VFTpIrj7oR8SaEQqzfOC3D3ChxLgZ3tEL070X9oeTEi5tFKp5B9rwAwXECeYkjKYX5W6pDjtwJj9+PiT8zf7fdtZgT+fPiNF9KMyr7bCugaAIRagmklVcwVMj9VqTvJi1EpZzJhwCK4tnhywavFQz1dWVqC08PyFevHCXoCUOEaQh9bsxhl4bS/rYEw3op9uqJdfXb124WlTuv0VWLlB4s0b5HVeq6usyC5WBbRC7LRWtLOla4tXW7XG4sUhwDGNxUMCFptCMl7QFqEWupRus5AgjXRb5aWOVDHduh033sjp1k7ZpJcikhd6G+Ttct+ZPXIV+vdC/07a0pntt3Q7YCxC7/WKUMTj7urFjScVoXbA8IFh15GsKEMZqWwyH//rmMZrw/pJWeizAhb6z1z4A/wvGL7YPq1rjibu6zfNk/L+APlS6vJFiA4YvljZ98rDNMKGtVwgtQ9pemFNJTpg2MDjP1I//qc5D9PsQ71sNr+Q6LyuDobvP+xLD7k1r3eNwz8sPzebTdM3om5Dq4ixbf76zVjDYSvz+9em3mq0jngbj3fiX+HuHeL+AXB4cZgoI8yuAAAAJXRFWHRkYXRlOmNyZWF0ZQAyMDE4LTA3LTMwVDA0OjUyOjI1KzAwOjAwf5iXMwAAACV0RVh0ZGF0ZTptb2RpZnkAMjAxOC0wNy0zMFQwNDo1MjoyNSswMDowMA7FL48AAAAASUVORK5CYII="/></a><div><span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Text" property="dct:title" rel="dct:type">Every blog post in this site</span><span> by </span><a xmlns:cc="http://creativecommons.org/ns#" href="https://github.com/laysent" property="cc:attributionName" rel="cc:attributionURL noopener noreferrer" target="_blank">LaySent</a><span> is licensed under a </span><a rel="license noopener noreferrer" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC 4.0 License</a><span>, based on a work at </span><a xmlns:dct="http://purl.org/dc/terms/" href="http://github.com/laysent/website" rel="dct:source noopener noreferrer" target="_blank">GitHub</a><span>. You can see the source code of this blog site at </span><a href="https://github.com/laysent/laysent.github.io" target="_blank" rel="noopener noreferrer">github.com/laysent/laysent.github.io</a><span>.</span></div></div></footer></article><hr style="margin-bottom:1.75rem"/><nav><ul style="display:flex;flex-wrap:wrap;justify-content:space-between;list-style:none;padding:0"><li><a rel="prev" href="/blog/post/migration-from-c-library-to-node-addon/">← <!-- -->使用 N-API 移植现有 C 语言库</a></li><li><a rel="next" href="/blog/post/random-sampling/">Random Sampling<!-- --> →</a></li></ul></nav><footer><span>© </span><span itemProp="copyrightYear">2019</span><span> </span><span itemProp="author" itemscope="" itemType="http://schema.org/Person"><span itemProp="name">LaySent</span></span></footer></main></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.page={"componentChunkName":"component---src-templates-blog-post-js","jsonName":"blog-post-android-app-reverse-engineering-tutorial-f83","path":"/blog/post/android-app-reverse-engineering-tutorial/"};window.dataPath="110/path---blog-post-android-app-reverse-engineering-tutorial-f-83-751-F4TzcM2CpSEPWxeDYR9pP14dQ";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app.3290113900e6c74c2b6d.css","/app-ecc524f4dcfa31ef9426.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-d31bd3902e603f920671.js"],"component---src-templates-category-js":["/component---src-templates-category-js-9f7667d0b964c5ed790a.js"],"component---src-templates-tag-js":["/component---src-templates-tag-js-c4e483c49e1e68607266.js"],"component---src-templates-til-per-month-js":["/component---src-templates-til-per-month-js-d724e7a529aec5303e96.js"],"component---src-pages-404-js":["/component---src-pages-404-js-09f292e4834bee06814b.js"],"component---src-pages-blog-js":["/component---src-pages-blog-js-3aa1de1ef36243e675e3.js"],"component---src-pages-index-js":["/component---src-pages-index-js.2d75cfbc826ecb18b744.css","/component---src-pages-index-js-97d25b9dc90f0acf1d27.js"],"component---src-pages-til-js":["/component---src-pages-til-js-5b7844da593262704419.js"],"pages-manifest":["/pages-manifest-88e1aa10594e8f237a77.js"],"katex":[]};/*]]>*/</script><script src="/webpack-runtime-affded7bd860e9973444.js" async=""></script><script src="/app-ecc524f4dcfa31ef9426.js" async=""></script><script src="/0-05a468e8ca35df48296c.js" async=""></script><script src="/component---src-templates-blog-post-js-d31bd3902e603f920671.js" async=""></script></body></html>
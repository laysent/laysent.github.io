{"componentChunkName":"component---src-templates-til-per-month-js","path":"/til/2019/10","result":{"data":{"site":{"siteMetadata":{"title":"LaySent's Site"}},"allMarkdownRemark":{"edges":[{"node":{"id":"8851beea-d663-5eca-a70d-daacfb58475f","html":"<p>在 Houdini 实现的过程中（<a href=\"https://developers.google.com/web/updates/2016/05/houdini\">什么是 Houdini？</a>），Chrome 已经在 66 中已经实现了一部分 CSS 样式的 Typed Object Modal 支持（支持的列表可以参考<a href=\"https://chromium.googlesource.com/chromium/src/+/master/third_party/blink/renderer/core/css/cssom/README.md\">这里</a>）。</p>\n<p>实现之后，在 JavaScript 中就可以通过 <code class=\"language-text\">window.CSS</code> 对象上的各类属性 API，生成指定类型的 CSS 属性值。看一个简单的例子：</p>\n<p>在以前的实现中，往往需要这么写代码：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> fontSize <span class=\"token operator\">=</span> <span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>element<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>fontSize<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token string\">'px'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nelement<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>fontSize <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>fontSize <span class=\"token operator\">*</span> <span class=\"token number\">2</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">px</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\nelement<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>opacity <span class=\"token operator\">=</span> <span class=\"token number\">0.1</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>这样写，会存在几个问题：</p>\n<ol>\n<li>读取和设置带单位数值的时候，需要在字符串和数字之间进行转化；</li>\n<li>CSS 的属性名称是用 <code class=\"language-text\">-</code> 连接的，但是在 <code class=\"language-text\">CSSStyleDeclaration</code> 中却需要写成小驼峰的形式（<code class=\"language-text\">font-size</code> 变成 <code class=\"language-text\">fontSize</code>）；</li>\n<li>如果设置违法的值，代码会默默失败，没有任何错误提示；</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">element<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>opacity <span class=\"token operator\">=</span> <span class=\"token number\">0.1</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// no error! not success!</span>\nelement<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>opacity <span class=\"token operator\">=</span> <span class=\"token string\">'?'</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// output: 0.1</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>element<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>opacity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<ol start=\"4\">\n<li>即使设置的属性值是数字，但是实际拿到的时候，值又变成了字符串</li>\n</ol>\n<p>如，上例中的 <code class=\"language-text\">element.style.opacity</code>，虽然设置的值是 <code class=\"language-text\">1</code>，但如果运行 <code class=\"language-text\">typeof element.style.opacity</code> 结果却是 <code class=\"language-text\">string</code></p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">element<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>opacity <span class=\"token operator\">=</span> <span class=\"token number\">0.1</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// output: string</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> element<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>opacity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>如果试图直接进行运算，则可能得不到预料中的结果。比如，下面的输出依然是 <code class=\"language-text\">0.1</code> 而不是 <code class=\"language-text\">0.6</code>，因为 <code class=\"language-text\">element.style.opacity += 0.5</code> 的结果是 <code class=\"language-text\">0.10.5</code>（字符串拼接），作为一个非法值，直接被浏览器抛弃了（见第三点）</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">element<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>opacity <span class=\"token operator\">=</span> <span class=\"token number\">0.1</span><span class=\"token punctuation\">;</span>\nelement<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>opacity <span class=\"token operator\">+=</span> <span class=\"token number\">0.5</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// output: 0.1</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>element<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>opacity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>有了 CSS Typed Object Model 之后，代码可以改写成这样：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> fontSize <span class=\"token operator\">=</span> element<span class=\"token punctuation\">.</span>attributeStyleMap<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'font-size'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">;</span>\nelement<span class=\"token punctuation\">.</span>attributeStyleMap<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'font-size'</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">CSS</span><span class=\"token punctuation\">.</span><span class=\"token function\">px</span><span class=\"token punctuation\">(</span>fontSize <span class=\"token operator\">*</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nelement<span class=\"token punctuation\">.</span>attributeStyleMap<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'opacity'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>不难看出，这样的写法，基本解决了上面提到的几个问题：</p>\n<ol>\n<li>读取和设置带单位数值的时候，不再需要手动进行字符串和数值的转化。<code class=\"language-text\">CSS.px</code> 这个函数可以将数值转化成一个带单位的对象，用于给 <code class=\"language-text\">attributeStyleMap</code> 赋值。另外，由于这个值 <code class=\"language-text\">toString</code> 之后就是类似 <code class=\"language-text\">16px</code> 的字符串，因此也可以直接给 <code class=\"language-text\">element.style.fontSize</code> 进行赋值。同时，从 <code class=\"language-text\">attributeStyleMap</code> 中拿到的数据，也是带单位的对象，对象中的 <code class=\"language-text\">value</code> 就是数值，<code class=\"language-text\">unit</code> 是字符串，表示单位，不再需要手动解析；</li>\n<li><code class=\"language-text\">attributeStyleMap</code> 的属性名称和 CSS 的属性名称是一致的，不需要像以前一样在 JavaScript 中手动改成小驼峰的写法；</li>\n<li>如果设置了违法的值，代码会报错：</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n  element<span class=\"token punctuation\">.</span>attributeStyleMap<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'opacity'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'?'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>以上代码会输出报错：<code class=\"language-text\">TypeError: Failed to execute &#39;set&#39; on &#39;StylePropertyMap&#39;: Invalid type for property</code>。</p>\n<ol start=\"4\">\n<li>应该是数值的结果，拿到的时候也是数值，而不是字符串（因此数值计算也不会出错）：</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">element<span class=\"token punctuation\">.</span>attributeStyleMap<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'opacity'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// output: number</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> element<span class=\"token punctuation\">.</span>attributeStyleMap<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'opacity'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>当然，这里如果这么些，结果依然是数字：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">element<span class=\"token punctuation\">.</span>attributeStyleMap<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'opacity'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'1'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// output: number!</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> element<span class=\"token punctuation\">.</span>attributeStyleMap<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'opacity'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>另外，使用 CSS Typed OM 还有一些其他额外的好处，比如，浏览器不需要序列化和反序列化结果，因此性能更好（一个简单的性能检测可以查看<a href=\"https://github.com/w3c/css-houdini-drafts/issues/634#issuecomment-366358609\">这里</a>，大概有 30% 左右的提升）。</p>\n<p>更多更详细关于 CSS Typed OM 的介绍，可以参考 Google 的这篇 <a href=\"https://developers.google.com/web/updates/2018/03/cssom\">Blog</a>。</p>\n<p>P.S. 目前，其他的浏览器支持情况依然不理想，可以参考 <a href=\"https://ishoudinireadyyet.com/\">Is Houdini ready yet?</a> 网站上最新的支持情况了解详情。就实际情况来看，可以在 Electron 3 （基于 Chrome 66，见<a href=\"https://electronjs.org/releases/stable?version=3&#x26;page=7\">这里</a>）或以上版本使用，但暂时不建议在 Web 项目中引入。</p>","frontmatter":{"date":"2019-10-30","title":"CSS Typed Object Model","category":"CSS"}}},{"node":{"id":"332fb33c-4a96-53f4-bc6b-152610186b51","html":"<p>Mobx 中，可以直接通过 <code class=\"language-text\">observable</code> 的方式来控制内部的 state，而不再使用 React 自带的 state 功能。一般的写法如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">import</span> React <span class=\"token keyword\">from</span> <span class=\"token string\">'react'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> observer <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'mobx-react'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> observable <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'mobx'</span><span class=\"token punctuation\">;</span>\n\n@observer\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Demo</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">React<span class=\"token punctuation\">.</span>Component</span> <span class=\"token punctuation\">{</span>\n  @observable num<span class=\"token punctuation\">:</span> <span class=\"token builtin\">number</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function-variable function\">onClick</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>num <span class=\"token operator\">+=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>button</span> <span class=\"token attr-name\">onClick</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>onClick<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">Clicked: </span><span class=\"token punctuation\">{</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>num<span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>button</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>这样写的优势在于，可以将何时渲染的判断交给了 Mobx 去处理，不用手动去处理。</p>\n<p>对于需要用到 <code class=\"language-text\">observable</code> 组合数据的情况，可以使用 <code class=\"language-text\">computed</code> 来生成一个新的 <code class=\"language-text\">observable</code> 值，也可以直接使用 getter 函数。以下的两个方案在效果上是等价的：</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\">@observer\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Demo</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">React<span class=\"token punctuation\">.</span>Component</span> <span class=\"token punctuation\">{</span>\n  @observable num<span class=\"token punctuation\">:</span> <span class=\"token builtin\">number</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function-variable function\">onClick</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>num <span class=\"token operator\">+=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">get</span> <span class=\"token function\">isMany</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>num <span class=\"token operator\">></span> <span class=\"token number\">5</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>button</span> <span class=\"token attr-name\">onClick</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>onClick<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        Clicked </span><span class=\"token punctuation\">{</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>isMany <span class=\"token operator\">?</span> <span class=\"token string\">'many'</span> <span class=\"token punctuation\">:</span> <span class=\"token string\">'few'</span><span class=\"token punctuation\">}</span><span class=\"token plain-text\"> times\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>button</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> observable<span class=\"token punctuation\">,</span> computed <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'mobx'</span><span class=\"token punctuation\">;</span>\n\n@observer\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Demo</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">React<span class=\"token punctuation\">.</span>Component</span> <span class=\"token punctuation\">{</span>\n  @observable num<span class=\"token punctuation\">:</span> <span class=\"token builtin\">number</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function-variable function\">onClick</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>num <span class=\"token operator\">+=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  @computed\n  <span class=\"token keyword\">get</span> <span class=\"token function\">isMany</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>num <span class=\"token operator\">></span> <span class=\"token number\">5</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>button</span> <span class=\"token attr-name\">onClick</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>onClick<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        Clicked </span><span class=\"token punctuation\">{</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>isMany <span class=\"token operator\">?</span> <span class=\"token string\">'many'</span> <span class=\"token punctuation\">:</span> <span class=\"token string\">'few'</span><span class=\"token punctuation\">}</span><span class=\"token plain-text\"> times\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>button</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>之所以两者是等价的，理由很简单。在执行 render 函数的时候，Mobx 注意到 <code class=\"language-text\">this.isMany</code> 被使用了，而在调用这个 getter 函数的时候，实际使用到了 <code class=\"language-text\">this.num</code> 这个 observable。因此，当 <code class=\"language-text\">this.num</code> 发生了变化之后，Mobx 知道需要重新调用 render 函数进行绘制。而对于使用了 computed 的情况来说，情况会更简单一些，<code class=\"language-text\">this.num</code> 这个 observable 的变化触发了 <code class=\"language-text\">this.isMany</code> 的重新计算，最终在 <code class=\"language-text\">this.isMany</code> 值变化之后触发了 render 函数的重新计算。</p>\n<p>然而需要注意的一点是，两者只是在效果上等价。在实际运算过程中，computed 的方案有两个优势：</p>\n<ol>\n<li>代码看上去更清晰。render 是因为 computed 的数据触发的，这一点在代码上可以很容易的看出来；而第一种方案，是否触发 getter 函数，其实需要多思考一下才能确定；</li>\n<li>实际执行效率更高。使用 getter 的方案，由于 render 函数实际上是和 <code class=\"language-text\">this.num</code> 这个 observable 进行关联的，因此哪怕 <code class=\"language-text\">this.isMany</code> 这个 getter 函数没有发生值的变化，只要 <code class=\"language-text\">this.num</code> 变了，render 函数都需要被执行；而对于使用 computed 的情况，因为 render 是和 <code class=\"language-text\">this.isMany</code> 进行关联的，实际 <code class=\"language-text\">this.isMany</code> 没有变化的时候，是不需要触发重绘的。换句话说，前者 getter 的方案，在 <code class=\"language-text\">this.num</code> 从 1 涨到 6 的过程中，一共触发了五次重新渲染；而后者 <code class=\"language-text\">computed</code> 的方案，只触发了一次重新渲染（当 <code class=\"language-text\">this.num = 6</code> 的时候）</li>\n</ol>\n<p>针对第二点，Mobx 的 GitHub issue 中作者也有相关的说明，见<a href=\"https://github.com/mobxjs/mobx/issues/161#issuecomment-196744152\">这里</a>。</p>","frontmatter":{"date":"2019-10-29","title":"computed and getter in Mobx","category":"JavaScript"}}},{"node":{"id":"15786218-7294-5212-8a5c-878f74283838","html":"<p>在 Node.js 中，可以通过 <code class=\"language-text\">os</code> 模块的 <code class=\"language-text\">networkInterfaces</code> API 来获取当前机器的 IP 数据。返回的结果类似于 <code class=\"language-text\">ifconfig</code> 或 <code class=\"language-text\">ipconfig</code> 命令。</p>\n<p>以获取当前主机的 IPv4 地址为例，可以写类似如下的代码：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">getIPAddress</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> interfaces <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'os'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">networkInterfaces</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> results <span class=\"token operator\">=</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">values</span><span class=\"token punctuation\">(</span>interfaces<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">flat</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token keyword\">interface</span></span> <span class=\"token operator\">=></span> <span class=\"token keyword\">interface</span><span class=\"token punctuation\">.</span>family <span class=\"token operator\">===</span> <span class=\"token string\">'IPv4'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token keyword\">interface</span></span> <span class=\"token operator\">=></span> <span class=\"token operator\">!</span><span class=\"token keyword\">interface</span><span class=\"token punctuation\">.</span>internal<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>results<span class=\"token punctuation\">.</span>length <span class=\"token operator\">===</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> results<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>address<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>简单的说明如下：</p>\n<ul>\n<li><code class=\"language-text\">internal</code> 用于表示当前的地址是否是本地回环地址或是其他外部无法访问的地址（例：127.0.0.1）；</li>\n<li><code class=\"language-text\">family</code> 用于表示当前地址的类型，将会是 <code class=\"language-text\">IPv4</code> 或 <code class=\"language-text\">IPv6</code> 中的一种；</li>\n<li><code class=\"language-text\">address</code> 用于表示当前的 IP 地址；</li>\n<li><code class=\"language-text\">os.networkInterfaces</code> 的返回是一个对象，key 用于表示 network interface，比如常见的 <code class=\"language-text\">lo</code> 或者 <code class=\"language-text\">eth0</code> 等。</li>\n</ul>\n<p>更多的返回数据及解释，可以参考<a href=\"https://nodejs.org/api/os.html#os_os_networkinterfaces\">官方文档</a>。</p>","frontmatter":{"date":"2019-10-28","title":"Get Current IP Address","category":"JavaScript"}}},{"node":{"id":"9476da5c-4afa-59a0-8cca-d1690d1b4bc0","html":"<p>在一个网站中，并不是所有的页面都希望被搜索引擎的爬虫收录。为此，可以通过一些特殊的 meta 信息，来调节搜索引擎爬虫的行为。</p>\n<section><h2>nofollow</h2><p>使用方法如下：</p><div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>meta</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>robots<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">content</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>nofollow<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span></code></pre></div><p>或者，针对页面上某一个具体的链接，也可以加上 <code class=\"language-text\">nofollow</code> 的标记：</p><div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>a</span> <span class=\"token attr-name\">href</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>some-link-to-backend-login-page<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">rel</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>nofollow<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span></code></pre></div><p>有了 <code class=\"language-text\">nofollow</code> 的标记，搜索引擎的爬虫就不会做进一步的爬取操作了。对于第一种写法，当前页面内所有的链接地址爬虫都不会再去访问了；对于第二种写法，则是这个指定的链接在本次爬取中不会被访问（如果其他地方有引用，且没有加上 <code class=\"language-text\">nofollow</code> 的标记，搜索引擎依然可能会去访问这个页面）。</p><p>一些常见的使用场景：付费访问的页面、不被信任的页面（比如一些留言板快）等。</p></section>\n<section><h2>noindex</h2><p>如果希望爬虫不要将当前页面的访问结果存储到数据库中用于未来搜索结果的展示，可以使用 <code class=\"language-text\">noindex</code> 标记。用法如下：</p><div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>meta</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>robots<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">content</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>noindex<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span></code></pre></div><p>一些常见的使用场景：后台登陆页面、感谢页面（SEO 的价值不大）或是一些内容动态的页面。</p></section>\n<section><h2>noindex nofollow</h2><p>对于既不希望爬虫进一步访问，也不希望结果被收录的页面，可以将两者都加上：</p><div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>meta</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>robots<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">content</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>noindex nofollow<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span></code></pre></div></section>","frontmatter":{"date":"2019-10-24","title":"noindex & nofollow","category":"SEO"}}},{"node":{"id":"6e82ef91-2e1a-58b0-879c-7e2818cfb8fd","html":"<p>在 Webpack 的配置中，有一个 <code class=\"language-text\">performance</code> 选项。根据 <code class=\"language-text\">performance</code> 中的配置，Webpack 可以针对打包后的结果的实际大小，进行警告或报错。</p>\n<p>具体的配置参数如下：</p>\n<ul>\n<li><code class=\"language-text\">performance.hints</code></li>\n</ul>\n<p>这个参数用于告诉 Webpack 最终产生的报告需要以什么样的方式呈现出来。可能的配置包括 <code class=\"language-text\">false</code>，<code class=\"language-text\">&#39;warning&#39;</code> 和 <code class=\"language-text\">&#39;error&#39;</code>。建议在 CI 中将这部分配置成 <code class=\"language-text\">&#39;error&#39;</code>，保证过大体积的文件无法被发布到线上。</p>\n<p>而具体多大的文件算“过大”，则需要用到下面提到的两个参数：</p>\n<ul>\n<li><code class=\"language-text\">performance.maxEntrypointSize</code></li>\n<li><code class=\"language-text\">performance.maxAssetSize</code></li>\n</ul>\n<p>前者表示入口文件能接受的最大文件尺寸（单位是 byte），后者表示其他生成的文件所能接受的最大尺寸（默认情况下包括了所有的 CSS，非入口 JS 文件，以及字体、图片等文件）。</p>\n<p>比如，入口 JavaScript 文件不能超过 250kb，而其余文件不能超过 100kb：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">module<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  performance<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    maxEntrypointSize<span class=\"token punctuation\">:</span> <span class=\"token number\">250_000</span><span class=\"token punctuation\">,</span>\n    maxAssetSize<span class=\"token punctuation\">:</span> <span class=\"token number\">100_000</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>默认情况下，除了 <code class=\"language-text\">.map</code> 文件外，所有其他产生的文件都会被考虑在内。如果希望改变这个默认的行为，可以使用下面的这个参数：</p>\n<ul>\n<li><code class=\"language-text\">performance.assetFilter</code></li>\n</ul>\n<p>比如，只考虑 JavaScript 文件：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">module<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  performance<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">assetFilter</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">assetFilename</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> assetFilename<span class=\"token punctuation\">.</span><span class=\"token function\">endsWith</span><span class=\"token punctuation\">(</span><span class=\"token string\">'.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>官方文档在<a href=\"https://webpack.js.org/configuration/performance/\">这里</a>。</p>","frontmatter":{"date":"2019-10-23","title":"Webpack File Limit Error","category":"Build"}}},{"node":{"id":"9c56df61-73a4-5eb4-a4eb-4158947a5a66","html":"<p><code class=\"language-text\">document.designMode</code> 这个属性，可以用于控制当前的整个页面是否可以直接被编辑。可以设置的属性值包括 <code class=\"language-text\">on</code> 和 <code class=\"language-text\">off</code> 两种。如果设置为 <code class=\"language-text\">on</code>，那么相当于开启了全页面范围的 <code class=\"language-text\">contenteditable=true</code>。默认情况下，这个值是 <code class=\"language-text\">off</code>。</p>\n<p>通过开关这个值，非程序员也可以轻松的对当前页面进行简单的修改（主要是文案的部分）。一些简单的需求，PM 和 UX 就可以直接进行尝试，而不需要再借助程序员的帮忙了。当然，对页面“造假”的门槛也变低了。</p>\n<p>可以通过下面的按钮来实际体验一下这个功能。</p>\n<p>\n  <button onclick=\"document.designMode=(document.designMode==='off'?'on':'off')\">\n    Toggle Design Mode\n  </button>\n</p>\n<p>更多的说明及浏览器支持情况（基本可以认为全支持），可以参考 <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Document/designMode\">MDN</a>。</p>","frontmatter":{"date":"2019-10-22","title":"Document DesignMode","category":"JavaScript"}}},{"node":{"id":"c53d17b5-4c70-5421-bcc4-1ee6a0e8cffc","html":"<p>要获取一个 NPM 包所有的版本信息，可以使用 <code class=\"language-text\">npm view</code> 这个命令。比如，检查 React 这个包的所有版本，并输出成 JSON 格式：</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">npm</span> view react versions --json</code></pre></div>\n<p>当然，以上只是 CLI 的操作方式，如果希望可以通过编程的方式去了解一个 NPM 包的相关信息，需要换一个方式。注意到 NPM 本身也是一个 <a href=\"https://www.npmjs.com/package/npm\">NPM 包</a>，对应的源码可以在 <a href=\"https://github.com/npm/cli\">GitHub</a> 上找到。其中，<code class=\"language-text\">npm view</code> 这个命令，对应的代码是 <a href=\"https://github.com/npm/cli/blob/c1522be2406a0ea4f14c85753edd42ddd8d7e180/lib/view.js\">lib/view.js</a>。</p>\n<p>通过观察这个文件，不难发现，NPM 底层依赖的其实是 <a href=\"https://www.npmjs.com/package/libnpm\">libnpm</a> 这个库。其中，获取包信息的部分，使用的是 <code class=\"language-text\">libnpm/packument</code> 这个部分。而根据文档，这里 <code class=\"language-text\">libnpm/packument</code> 本质上就是将 <a href=\"https://www.npmjs.com/package/pacote\">pacote</a> 中的 <code class=\"language-text\">packument</code> 接口开放了出来。</p>\n<p>实际的使用方法如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> packument <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'libnpm/packument'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getVersions</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token keyword\">package</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> versions <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">packument</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">package</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// to use custom registry</span>\n    registry<span class=\"token punctuation\">:</span> <span class=\"token string\">'https://registry.npm.taobao.org'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token comment\">// get all meta data</span>\n    fullMetadata<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n    <span class=\"token comment\">// prefer to get latest online data</span>\n    <span class=\"token string\">'prefer-online'</span><span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> versions<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>其中，<code class=\"language-text\">packument</code> 这个 API 的返回数据格式，可以参考 <code class=\"language-text\">@types/pacote</code> 中的相关<a href=\"https://github.com/DefinitelyTyped/DefinitelyTyped/blob/25fe77861d42ff01903fe2e2d1014b3ed354bfde/types/pacote/index.d.ts#L98\">定义</a>。</p>\n<p>需要额外注意的一点是：npm 和一些 registry 服务使用的数据格式可能略有区别。举例来说，npm 的返回数据里，每个版本的 <code class=\"language-text\">dist</code> 中可能包含 <code class=\"language-text\">unpackedSize</code> 数据（optional），表示该版本文件实际的大小；而 <a href=\"https://github.com/npm/cli\">cnpm</a> 返回的数据中，<code class=\"language-text\">dist</code> 内包含的是 <code class=\"language-text\">size</code> 数据（<a href=\"https://github.com/cnpm/cnpmjs.org/blob/26d7147562a1ae21db8bfec26983daf311353d96/models/module.js#L74\">源代码</a>），表示该版本的压缩文件 tar 的大小。</p>","frontmatter":{"date":"2019-10-21","title":"Get Npm Package Info","category":"JavaScript"}}},{"node":{"id":"b5fcadf5-c222-517c-b058-073a0dd96eb8","html":"<p>在 Bash 中，可以通过以下的命令跳转回上一个访问的目录：</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">cd</span> -</code></pre></div>\n<p>换句话说，<code class=\"language-text\">cd -</code> 可以在最后访问的两个目录间来回跳转。</p>","frontmatter":{"date":"2019-10-20","title":"back to previous folder","category":"Bash"}}},{"node":{"id":"9fb9628c-3773-588d-a419-ec8b93547acf","html":"<p><code class=\"language-text\">-webkit-app-region</code> 是一个 Electron 中的 CSS 属性，可以用于指明用户是否可以通过拖拽当前的 HTML 元素来完成对整个窗体的拖拽。这种情况主要是针对 <a href=\"https://electronjs.org/docs/api/frameless-window\">frameless</a> 窗口的。因为对于 frameless 窗口来说，由于没有了顶部 toolbar，所以默认是无法让用户直接拖拽的。<code class=\"language-text\">-webkit-app-region</code> 相当于提供了一个编程可指明的自定义拖拽区域，用于实现类似窗口顶部 toolbar 的效果。</p>\n<p>具体的使用方法非常简单，只需要针对特定的 HTML 元素，应用如下的 CSS 就可以了：</p>\n<div class=\"gatsby-highlight\" data-language=\"css\"><pre class=\"language-css\"><code class=\"language-css\"><span class=\"token selector\">.draggable</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">-webkit-app-region</span><span class=\"token punctuation\">:</span> drag<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>当然，这里需要注意到的一点是，如果一个区域因为某个 HTML 元素的存在变成了 <code class=\"language-text\">-webkit-app-region: drag</code>，那么对于 Windows 系统来说（Mac 经测试不会有这个问题），这个区域上的其他元素（不论是否在 drag 元素的“上方”）都无法收到鼠标的事件（如 click / hover 等）。如果希望可以继续保留某些元素（比如按钮）的鼠标事件，需要在这些元素上通过如下的方式显示声明：</p>\n<div class=\"gatsby-highlight\" data-language=\"css\"><pre class=\"language-css\"><code class=\"language-css\"><span class=\"token selector\">.button</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">-webkit-app-region</span><span class=\"token punctuation\">:</span> no-drag<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Electron 相关的<a href=\"https://electronjs.org/docs/api/frameless-window#draggable-region\">文档说明</a>。</p>\n<p>关于使用 <code class=\"language-text\">-webkit-app-region: drag</code> 后其他区域内元素就无法收获鼠标事件的讨论，可以参考 Electron 的<a href=\"https://github.com/electron/electron/issues/1354#issuecomment-90315551\">这个 issue</a>。</p>","frontmatter":{"date":"2019-10-17","title":"webkit-app-region","category":"Electron"}}},{"node":{"id":"79325fcf-6c20-50a0-9a24-d1a5178dedb0","html":"<p>因为 Electron 项目天然的集成了 Node.js，可以直接使用 <code class=\"language-text\">require</code> 命令来加载其他的模块。因此，很多项目中就不再使用 Webpack 或 Rollup 来对项目进行打包操作。简单的使用 TypeScript 或 Babel 进行转化，保证 <code class=\"language-text\">import</code> 转化成了 <code class=\"language-text\">require</code> 命令，就能顺利的跑起来了。</p>\n<p>然而，如果细究下去，直接使用 <code class=\"language-text\">require</code> 依次加载各个文件和通过打包将所有需要加载的部分一次性载入，两者之间还是存在这性能上的差距。具体的数据差异，可以通过这个<a href=\"https://github.com/laysent/electron-require-test\">测试项目</a>来实际了解。</p>\n<p>实测中，大约 1000 个文件，打包和不打包的版本，载入的时间差距在 200ms 以上。对于用户来说，这个已经是可感知的延迟了（参考<a href=\"https://www.humanbenchmark.com/tests/reactiontime\">数据</a>）。</p>\n<p>一次 Electron require 涉及的步骤包括：</p>\n<ol>\n<li>根据请求的地址，寻找文件（Electron 的 <a href=\"https://github.com/electron/electron/blob/24b3d66767d89c0b119d1fcc738db4b7f456d913/lib/common/reset-search-paths.ts#L36\">_resolveFilename</a> 方法 > Node.js 中的 <a href=\"https://github.com/nodejs/node/blob/a6b030d5ac2c4a2d34f6b9eb3f945d252a42843e/lib/internal/modules/cjs/loader.js#L787\">_resolveFilename</a> 方法 > <a href=\"https://github.com/nodejs/node/blob/a6b030d5ac2c4a2d34f6b9eb3f945d252a42843e/lib/internal/modules/cjs/loader.js#L495\">_findPath</a> 方法 > <a href=\"https://github.com/nodejs/node/blob/a6b030d5ac2c4a2d34f6b9eb3f945d252a42843e/lib/internal/modules/cjs/loader.js#L118\">stat</a> 方法）</li>\n<li>根据实际地址读取文件（Node.js 的 <a href=\"https://github.com/nodejs/node/blob/a6b030d5ac2c4a2d34f6b9eb3f945d252a42843e/lib/internal/modules/cjs/loader.js#L822\">Module.prototype.load</a> 方法 > <a href=\"https://github.com/nodejs/node/blob/a6b030d5ac2c4a2d34f6b9eb3f945d252a42843e/lib/internal/modules/cjs/loader.js#L980\">Module._extensions[‘.js’]</a> 方法 > <a href=\"https://github.com/nodejs/node/blob/a6b030d5ac2c4a2d34f6b9eb3f945d252a42843e/lib/internal/modules/cjs/loader.js#L1010\">fs.readFileSync</a> 方法）</li>\n<li>编译加载文件内容（Node.js 的 <a href=\"https://github.com/nodejs/node/blob/a6b030d5ac2c4a2d34f6b9eb3f945d252a42843e/lib/internal/modules/cjs/loader.js#L931\">Module.prototype._compile</a> 方法）</li>\n</ol>\n<p>其中，第一步和第二步的 IO 都是比较耗时的操作。特别是对于第一步来说，寻找文件是一个过程。对于非相对路径的文件来说，如果不能在当前的 node_modules 下找到，Node.js 就会逐级往上寻找，直到成功或最终失败。第三步编译和运行的过程，耗时将和内容具体的长短以及具体执行的内容相关。</p>\n<p>由于不论是直接 require 的方法还是打包的操作，最终需要执行的程序都是基本相同的（对于 Webpack 来说，有一些 runtime 代码的消耗），也就是第三步的时间两个方案都是大体相同的。因而总体上来说，两种方案的差异主要体现在第一步和第二步的耗时上。由于单个打包文件加载的方案可以节省多次 IO 的查找和读取操作，因而最终会节省不少的时间。</p>","frontmatter":{"date":"2019-10-16","title":"Require Strategy in Electron","category":"Electron"}}},{"node":{"id":"cd182026-2d57-5a6b-83b4-a7f384ce0957","html":"<p>在日常的开发过程中，对于一个按钮或者链接，一般会附上一个 <code class=\"language-text\">onClick</code> 事件，以响应用户的点击操作。当用户实际按下按钮或链接之后，再通过 <code class=\"language-text\">onClick</code> 事件去触发之后要进行的流程（比如网络请求或是链接跳转等）。</p>\n<p>如果对于用户操作后的反馈速度有一定的要求，这里的行为就需要进行优化。以链接为例，一个常见的操作方法是（比如 <a href=\"https://github.com/GoogleChromeLabs/quicklink\">quicklink</a>），用程序对可视范围内的链接地址进行预加载（使用 <code class=\"language-text\">prefetch</code>）。这样，当用户真正点击的时候，资源很可能已经得到了加载，打开速度就会显著提升。</p>\n<p>当然，这样的行为是没有预判的，纯粹暴力的进行可能的预备操作。如果预备操作损耗较多，这样的操作就显得不方便了。</p>\n<p>一个更加“智能”的操作是，仅当用户“点击”了之后才进行预加载。实际上，即使是一个点击的的操作，也会分成好几个不同的事件，包括 <code class=\"language-text\">MouseDown</code>，<code class=\"language-text\">MouseUp</code> 和 <code class=\"language-text\">Click</code>。在 <code class=\"language-text\">MouseDown</code> 和 <code class=\"language-text\">Click</code> 之间，差着大约 100ms 的时间。</p>\n<p>换句话说，如果在 <code class=\"language-text\">MouseDown</code> 的时候就开始预处理，等到 <code class=\"language-text\">Click</code> 时才真正进行加载，那么整体的加载时间会减少 100ms 左右。在某些情况下，这也是个不小的提升了。</p>\n<p>可以用下面的这段代码实际测试一下，<code class=\"language-text\">MouseDown</code> 事件和 <code class=\"language-text\">Click</code> 事件之间的时间差（具体时间差因人而异）：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> button <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">'button'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nbutton<span class=\"token punctuation\">.</span>textContent <span class=\"token operator\">=</span> <span class=\"token string\">'Click Me'</span><span class=\"token punctuation\">;</span>\nbutton<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onmousedown</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Mousedown: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>Date<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\nbutton<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onclick</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Click: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>Date<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\ndocument<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>button<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>也可以直接点击下面这个按钮尝试：</p>\n<button onmousedown=\"window.__down=Date.now()\" onclick=\"this.textContent='Took:'+(Date.now() - window.__down)+' ms'\">\n  Click Me\n</button>\n<p></p>\n<p>当然，比这个略激进的操作，可以将 <code class=\"language-text\">MouseDown</code> 事件换成 <code class=\"language-text\">MouseEnter</code> 事件，这样在 Hover 的时候就会开始预加载。大概能提前 300ms 左右开始操作，当然存在一定的误判风险（比如用户只是划过了鼠标，并没有想要点击的意愿）。</p>\n<p>可以参考 <a href=\"http://instantclick.io/\">InstantClick</a> 了解更多实现的细节。</p>","frontmatter":{"date":"2019-10-15","title":"MouseDown to Click","category":"JavaScript"}}},{"node":{"id":"d7262571-a581-5b2f-8938-103fb637b4ce","html":"<p>使用 Node 解析当前的 Git Config 文件，有两个可以辅助的 npm 库：</p>\n<ol>\n<li><code class=\"language-text\">git-config-path</code>：可以用于判断当前的 Git Config 地址</li>\n</ol>\n<p>例如，需要获取全局 Git Config 地址，可以运行：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> configPath <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'git-config-path'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token string\">'global'</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>更多可以参考<a href=\"https://github.com/jonschlinkert/git-config-path\">文档</a>。</p>\n<ol start=\"2\">\n<li><code class=\"language-text\">ini</code>：可以用于解析和处理 ini 类型的配置文件，<a href=\"https://github.com/jonschlinkert/parse-git-config\">parse-git-config</a> 也使用了这个来解析 Git Config 文件。</li>\n</ol>\n<p>简单的使用方法如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> configPath <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'git-config-path'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token string\">'global'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> ini <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'ini'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> content <span class=\"token operator\">=</span> fs<span class=\"token punctuation\">.</span><span class=\"token function\">readFileSync</span><span class=\"token punctuation\">(</span>configPath<span class=\"token punctuation\">,</span> <span class=\"token string\">'utf8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> parsed <span class=\"token operator\">=</span> ini<span class=\"token punctuation\">.</span><span class=\"token function\">decode</span><span class=\"token punctuation\">(</span>content<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> stringify <span class=\"token operator\">=</span> ini<span class=\"token punctuation\">.</span><span class=\"token function\">encode</span><span class=\"token punctuation\">(</span>parsed<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nfs<span class=\"token punctuation\">.</span><span class=\"token function\">writeFileSync</span><span class=\"token punctuation\">(</span>configPath<span class=\"token punctuation\">,</span> stringify<span class=\"token punctuation\">,</span> <span class=\"token string\">'utf8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>更多内容，可以参考<a href=\"https://github.com/npm/ini#readme\">文档</a>。</p>","frontmatter":{"date":"2019-10-14","title":"Parse GitConfig via Node","category":"Tool"}}},{"node":{"id":"9018df9c-3116-5212-8829-3e63b77ba5cd","html":"<p>在浏览器渲染 SVG 的时候，可以通过 <code class=\"language-text\">shape-rendering</code> 这一属性，来控制浏览器对 SVG 抗锯齿效果的展示。<code class=\"language-text\">shape-rendering</code> 支持从三个纬度来权衡 SVG 的渲染效果，这三个纬度分别是：速度、曲线精细度以及曲线的锐利程度。</p>\n<ul>\n<li><code class=\"language-text\">auto</code>，这个是默认值，表示由浏览器来决定改如何显示</li>\n<li><code class=\"language-text\">optimizeSpeed</code>，顾名思义，这个要求浏览器以渲染的速度优先，抗锯齿可能会被浏览器关闭</li>\n<li><code class=\"language-text\">crispEdges</code>，这个选项要求浏览器以曲线的锐利程度为第一优先级。这种情况下，速度和精细度的优先级会被降低。浏览器可能会关闭抗锯齿，或者只针对接近垂直和水平的线才开启抗锯齿的功能。同时，浏览器可能会微调线的位置和宽度，以适应显示器的物理像素点</li>\n<li><code class=\"language-text\">geometricPrecision</code>，这个选项要求浏览器以更好的精度来渲染图像，为此可能会牺牲渲染的性能（速度）和边界的清晰度</li>\n</ul>\n<p>下图从左到右分别展示了 <code class=\"language-text\">geometricPrecision</code>，<code class=\"language-text\">crispEdges</code> 和 <code class=\"language-text\">optimizeSpeed</code> 三种情况下，同一个圆的显示效果。</p>\n<svg viewBox=\"0 0 640 200\" xmlns=\"http://www.w3.org/2000/svg\" width=\"740\">\n  <circle cx=\"100\" cy=\"100\" r=\"100\" shape-rendering=\"geometricPrecision\" fill=\"#ff8787\" />\n  <circle cx=\"320\" cy=\"100\" r=\"100\" shape-rendering=\"crispEdges\" fill=\"#da77f2\" />\n  <circle cx=\"540\" cy=\"100\" r=\"100\" shape-rendering=\"optimizeSpeed\" fill=\"#748ffc\" />\n</svg>\n<p>不难看出，<code class=\"language-text\">geometricPrecision</code> 的效果是最平滑的，但是边缘清晰度不足；<code class=\"language-text\">crispEdges</code> 边缘很锐利，但是有一些毛边（越是低分辨率的屏幕，效果越明显）；<code class=\"language-text\">optimizeSpeed</code> 的显示效果也明显有毛边，不过效果和 <code class=\"language-text\">crispEdges</code> 略微不同，可以看得出底层使用的算法是不太一样的。</p>\n<p>上图的 HTML 代码如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>svg</span> <span class=\"token attr-name\">viewBox</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>0 0 640 200<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">xmlns</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>http://www.w3.org/2000/svg<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">width</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>740<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>circle</span>\n    <span class=\"token attr-name\">cx</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>100<span class=\"token punctuation\">\"</span></span>\n    <span class=\"token attr-name\">cy</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>100<span class=\"token punctuation\">\"</span></span>\n    <span class=\"token attr-name\">r</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>100<span class=\"token punctuation\">\"</span></span>\n    <span class=\"token attr-name\">shape-rendering</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>geometricPrecision<span class=\"token punctuation\">\"</span></span>\n    <span class=\"token attr-name\">fill</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>#ff8787<span class=\"token punctuation\">\"</span></span>\n  <span class=\"token punctuation\">/></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>circle</span>\n    <span class=\"token attr-name\">cx</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>100<span class=\"token punctuation\">\"</span></span>\n    <span class=\"token attr-name\">cy</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>100<span class=\"token punctuation\">\"</span></span>\n    <span class=\"token attr-name\">r</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>100<span class=\"token punctuation\">\"</span></span>\n    <span class=\"token attr-name\">shape-rendering</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>crispEdges<span class=\"token punctuation\">\"</span></span>\n    <span class=\"token attr-name\">fill</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>#da77f2<span class=\"token punctuation\">\"</span></span>\n  <span class=\"token punctuation\">/></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>circle</span>\n    <span class=\"token attr-name\">cx</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>100<span class=\"token punctuation\">\"</span></span>\n    <span class=\"token attr-name\">cy</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>100<span class=\"token punctuation\">\"</span></span>\n    <span class=\"token attr-name\">r</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>100<span class=\"token punctuation\">\"</span></span>\n    <span class=\"token attr-name\">shape-rendering</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>optimizeSpeed<span class=\"token punctuation\">\"</span></span>\n    <span class=\"token attr-name\">fill</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>#748ffc<span class=\"token punctuation\">\"</span></span>\n  <span class=\"token punctuation\">/></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>svg</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>另外，除了在 SVG 中直接写属性之外，也可以通过 CSS 来给 SVG 加上相关的 <code class=\"language-text\">shape-rendering</code> 值：</p>\n<div class=\"gatsby-highlight\" data-language=\"css\"><pre class=\"language-css\"><code class=\"language-css\"><span class=\"token selector\">svg</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">shape-rendering</span><span class=\"token punctuation\">:</span> geometricPrecision<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>MDN 的相关介绍见<a href=\"https://developer.mozilla.org/en-US/docs/Web/SVG/Attribute/shape-rendering\">这里</a>。</p>","frontmatter":{"date":"2019-10-11","title":"shape-rendering","category":"CSS"}}},{"node":{"id":"63fe13ef-a8b4-5225-8fe5-8e402f4609f3","html":"<p>图标的使用，之前的技术方案，一般都是使用特殊的字体文件进行的。而现在随着浏览器支持的变化，越来越多的技术方案开始迁移到直接使用 SVG 图标了。</p>\n<p>当然，为了迁移的平滑进行，最好是可以尽可能的避免改动。在 CSS 层面上，一般针对图标有两个需要设置的部分，一个是颜色，一个是大小。</p>\n<p>对于颜色，字体文件使用 <code class=\"language-text\">color</code> 属性进行着色。SVG 中可以用 <code class=\"language-text\">fill</code> 着色，用 <code class=\"language-text\">stroke</code> 描边。不过，由于 SVG 图标一般都是一个或多个 <code class=\"language-text\">path</code> 组成的，实际一般使用 <code class=\"language-text\">fill</code> 属性就可以了。这里，可以通过 CSS 中的 <code class=\"language-text\">currentColor</code> 来完成从 <code class=\"language-text\">color</code> 到 <code class=\"language-text\">fill</code> 的映射关系：</p>\n<div class=\"gatsby-highlight\" data-language=\"css\"><pre class=\"language-css\"><code class=\"language-css\"><span class=\"token selector\">.icon</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">fill</span><span class=\"token punctuation\">:</span> currentColor<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>其中，<code class=\"language-text\">currentColor</code> 的支持浏览器可以参考 <a href=\"https://caniuse.com/#feat=currentcolor\">caniuse</a>。总体上来说，IE 9+ 都是支持的，是一个不需要有太多顾虑就可以使用的功能。</p>\n<p>对于大小，字体文件使用 <code class=\"language-text\">font-size</code> 属性控制大小。SVG 中则使用 <code class=\"language-text\">width</code> 和 <code class=\"language-text\">height</code> 进行控制。这里可以取巧的对所有 SVG 图标统一设置一个如下的 CSS 样式，一步将大小的设置迁移过来：</p>\n<div class=\"gatsby-highlight\" data-language=\"css\"><pre class=\"language-css\"><code class=\"language-css\"><span class=\"token selector\">.icon</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">width</span><span class=\"token punctuation\">:</span> 1em<span class=\"token punctuation\">;</span>\n  <span class=\"token property\">height</span><span class=\"token punctuation\">:</span> 1em<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>上面的方案可以解决大部分的大小问题，但是要警惕部分字体图标也设置了 <code class=\"language-text\">width</code> 和 <code class=\"language-text\">height</code> 的情况。这种时候，图标占的空间由 <code class=\"language-text\">width</code> 和 <code class=\"language-text\">height</code> 确定，但是实际图标的大小由 <code class=\"language-text\">font-size</code> 确定。相当于 SVG 图标外面加上了一圈 <code class=\"language-text\">pending</code>。实际在迁移的时候，也可以用这个方案，将 <code class=\"language-text\">width</code> 和 <code class=\"language-text\">height</code> 改成和原先 <code class=\"language-text\">font-size</code> 一样的值，其中变化的差值部分用 <code class=\"language-text\">pending</code> 补上。</p>","frontmatter":{"date":"2019-10-10","title":"iconfont to svg","category":"CSS"}}},{"node":{"id":"448f8053-cdef-5e30-bca1-6db31d71d267","html":"<p>在 HTTP 协议中，301 Moved Permanently 和 308 Permanent Redirect 在语意上是一致的，都表示一个资源已经被永久性地转移到了一个新的地址（这一点和 302 / 307 对应，后者只是资源的地址被临时修改了）。在这种情况下，浏览器会跳转到新的资源地址，SEO 也会更新资源对应的数据信息。</p>\n<p>虽然 301 和 308 的语意是一致的，但是在实际的浏览器行为上，会有少许差别。根据 <a href=\"https://tools.ietf.org/html/rfc7231#section-6.4.2\">RFC7231</a> 中的表述，因为一些历史原因，客户端有可能会将 301 重定向的请求方法从 POST 修改为 GET。而根据 <a href=\"https://tools.ietf.org/html/rfc7538#section-3\">RFC7238</a> 中的定义，308 重定向是不允许客户端对请求方法进行修改的。</p>\n<p>这里 302 和 307 的区别也是同理。整体的区别见下表：</p>\n<table>\n<thead>\n<tr>\n<th>是否允许改变请求方法</th>\n<th>永久重定向</th>\n<th>临时重定向</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>允许</td>\n<td>301</td>\n<td>302</td>\n</tr>\n<tr>\n<td>不允许</td>\n<td>308</td>\n<td>307</td>\n</tr>\n</tbody>\n</table>","frontmatter":{"date":"2019-10-09","title":"HTTP Status 301 & 308","category":"HTTP"}}},{"node":{"id":"dd5f1e33-ac72-5dc8-a677-eabec28b82f9","html":"<p>在 JavaScript 中，对模块的引用声明一般写在文件的顶部，而实际引用的 API，可能在运行时的非常晚才会被真正的使用到。看上去，这些 <code class=\"language-text\">import</code> 语句并没有什么问题。但实际上，由于引用模块自身的初始化工作以及可能的副作用，<code class=\"language-text\">import</code> 带来的性能损耗有时候也是不容忽视的。</p>\n<p>首先来看下面这个 JavaScript 文件：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> defaults <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'lodash'</span><span class=\"token punctuation\">;</span>\n\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token function\">defaults</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token string\">'a'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token string\">'a'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'b'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// → { 'a': 1, 'b': 2 }</span></code></pre></div>\n<p>看上去是一段非常简单的 JavaScript 代码，只是执行了一个很简单的操作。基本等价于下面这段代码（Lodash 的 API 可以参考<a href=\"https://lodash.com/docs/4.17.15#defaults\">文档</a>）：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>Object<span class=\"token punctuation\">.</span><span class=\"token function\">assign</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token string\">'a'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'b'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token string\">'a'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>然而两者有一个很重要的区别，就是前者引用了 Lodash 的 API。这个看上去是一个非常简单的操作，但实际上也有不小的消耗。在程序执行 <code class=\"language-text\">import</code> 语句的时候，会加载 Lodash 完整的初始化代码，并给 <code class=\"language-text\">defaults</code> 变量赋值 Lodash 的 defaults API。其中，Lodash 的初始化代码完整执行完成，需要大概 15ms 左右的时间。实际上，如果改成只引用 <code class=\"language-text\">defaults</code> 这一个 API，最终的效果就会好很多：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">import</span> defaults <span class=\"token keyword\">from</span> <span class=\"token string\">'lodash/defaults'</span><span class=\"token punctuation\">;</span>\n\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token function\">defaults</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token string\">'a'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token string\">'a'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'b'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>如果累计了很多这样小的初始化成本，最终就会导致在应用实际启动的过程中，产生几百毫秒的延迟。这一点在 Web 应用中相对还好，毕竟体积和初始化速度多少存在着一些关系，而 Web 应用对体积非常的敏感；但是同样的问题，到了 Electron 项目中，就有可能变得不容小觑起来。作为 PC 级别的应用，Electron 的打包往往对体积没有那么严苛的要求。很多时候多一个库，少一个库，都没有太大的差别。然而，各个库初始化的速度累计起来，却有可能拖累本就不快的 App 启动速度。</p>\n<p>再举一个小例子。下面的这段代码看上去似乎没有什么问题：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> crypto <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'crypto'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">md5</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">input</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> crypto<span class=\"token punctuation\">.</span><span class=\"token function\">createHash</span><span class=\"token punctuation\">(</span><span class=\"token string\">'md5'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">update</span><span class=\"token punctuation\">(</span>input<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">digest</span><span class=\"token punctuation\">(</span><span class=\"token string\">'hex'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>然而，实际加载 crypto 模块可能需要 5ms 的时间。这个时间在初始化的时候就用掉了，但实际用到 crypto 模块的时间却可能还早（或者压根最终没触发）。考虑到 require 本身就有缓存的机制，将这一步骤放到第一次执行的时候再做，就可以省下这 5ms 的加载时间：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">md5</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">input</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'crypto'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">createHash</span><span class=\"token punctuation\">(</span><span class=\"token string\">'md5'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">update</span><span class=\"token punctuation\">(</span>input<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">digest</span><span class=\"token punctuation\">(</span><span class=\"token string\">'hex'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>当然，上面只是一些例子。真正在实际的项目中需要解决这一问题，第一步，就是知道有哪些代码在初始阶段被加载了，分别花了多长的时间。这看上去是一个挺麻烦的工作，但如果应用是使用 Webpack 进行打包的，那么问题就变得不那么麻烦了。</p>\n<p>Webpack 由于需要支持 HMR 以及 Dynamic Import，在编译的时候需要打包一个运行时进去，用于管理各个 Chunk 之间的引用（正因如此，Webpack 的打包体积往往会大于用 Rollup 打包的体积）。而正因为有了这个统一的运行时，使得模块间引用的耗时变得非常容易统计了。只需要在下面这行代码的前和后，分别用 Performance 进行一次打点计时，就可以很容易的知道每一个模块实际的加载耗时了。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">modules<span class=\"token punctuation\">[</span>moduleId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span>\n  module<span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">,</span>\n  module<span class=\"token punctuation\">,</span>\n  module<span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">,</span>\n  __webpack_require__\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>修改后的代码大概如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> performance <span class=\"token operator\">!==</span> <span class=\"token string\">\"undefined\"</span><span class=\"token punctuation\">)</span> performance<span class=\"token punctuation\">.</span><span class=\"token function\">mark</span><span class=\"token punctuation\">(</span>moduleId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nmodules<span class=\"token punctuation\">[</span>moduleId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span>\n  module<span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">,</span>\n  module<span class=\"token punctuation\">,</span>\n  module<span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">,</span>\n  __webpack_require__\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> performance <span class=\"token operator\">!==</span> <span class=\"token string\">\"undefined\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  performance<span class=\"token punctuation\">.</span><span class=\"token function\">measure</span><span class=\"token punctuation\">(</span>moduleId<span class=\"token punctuation\">,</span> moduleId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  performance<span class=\"token punctuation\">.</span><span class=\"token function\">clearMarks</span><span class=\"token punctuation\">(</span>moduleId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  performance<span class=\"token punctuation\">.</span><span class=\"token function\">clearMeasures</span><span class=\"token punctuation\">(</span>moduleId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>这里需要加上 <code class=\"language-text\">typeof performance !== &#39;undefined&#39;</code> 的主要原因是，一些 loader（如 css-loader）可能会在 Node 环境执行运行时的代码，这种情况下不可以直接调用 Performance 相关的 API，会报错。</p>\n<p>由于 Webpack 基于 Tapable 架构的关系，要编写一个插件来修改 Webpack 原本的运行时代码也非常的容易。观察 Webpack 的<a href=\"https://github.com/webpack/webpack/blob/758269e81456c946a96b521ee936dbec99d07132/lib/MainTemplate.js#L196\">源码</a> 不难发现，只需要针对 <code class=\"language-text\">mainTemplate</code> 的 <code class=\"language-text\">require</code> 进行一些改动就可以了。同时，从 Webpack 的代码历史来看，上面这句代码前后的 Comment 一直都没有变过。于是，只需要找到模块引用前后的注释，用字符串替换的方式，插入这些新的性能打点语句就可以了。</p>\n<p>最终的代码可以参考 NPM 的库 <a href=\"http://npmjs.com/package/webpack-require-performance-plugin\">webpack-require-performance-plugin</a>，源码在<a href=\"https://github.com/laysent/webpack-require-performance-plugin\">这里</a>。</p>","frontmatter":{"date":"2019-10-08","title":"Webpack Require Performance","category":"Build"}}}]}},"pageContext":{"isCreatedByStatefulCreatePages":false,"startInMonth":"2019-10-01","endInMonth":"2019-10-31","time":"2019-10","previous":"2019-09","next":null}}}
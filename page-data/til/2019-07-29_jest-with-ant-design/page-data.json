{"componentChunkName":"component---src-templates-til-js","path":"/til/2019-07-29_jest-with-ant-design","webpackCompilationHash":"d0c1c456129354e33ddb","result":{"data":{"markdownRemark":{"id":"68d67c21-2405-5153-9308-b645937f95e6","html":"<p>当 Ant Design 和 Jest 一起使用的时候，在某些情况下（开启 coverage 的时候）会导致单元测试运行失败。一个可能造成问题的 Ant Design 代码如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Input <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'antd'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> TextArea <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> Input<span class=\"token punctuation\">;</span></code></pre></div>\n<p>Jest 会报错：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">ReferenceError: Input is not defined\n\n  1 | import { Input } from &#39;ant-design&#39;;\n  2 |\n&gt; 3 | const { TextArea } = Input;</code></pre></div>\n<p>报错的直接原因，是使用了 Ant Design 推荐的 <code class=\"language-text\">babel-plugin-import</code> 和 Jest 计算 coverage 使用的 <code class=\"language-text\">babel-plugin-istanbul</code> 造成的。在<a href=\"https://github.com/ant-design/babel-plugin-import/issues/172\">这里</a>、<a href=\"https://github.com/ant-design/babel-plugin-import/issues/189#issuecomment-445139343\">这里</a>等 GitHub Issue 中都有相应的讨论。</p>\n<p>要修复这个问题，只需要在 Jest 或者单元测试环境中，不使用 <code class=\"language-text\">babel-plugin-import</code> 这个转换插件就可以了。参考代码如下，在 <code class=\"language-text\">.babelrc</code> 中：</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"env\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"development\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"plugins\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">[</span>\n          <span class=\"token string\">\"import\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">\"libraryName\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"antd\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"style\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">]</span>\n      <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"production\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// same as above</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"plugins\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token comment\">// rest of plugins...</span>\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>如此一来，只有在 <code class=\"language-text\">NODE_ENV</code> 为 <code class=\"language-text\">production</code> 或 <code class=\"language-text\">development</code> 的情况下，Babel 才会启用 <code class=\"language-text\">babel-plugin-import</code> 这个转换插件。对于 Jest 来说，因为默认设置了环境变量 <code class=\"language-text\">NODE_ENV</code> 为 <code class=\"language-text\">test</code>，所以 Plugin 不会起效。</p>\n<p>这样造成的问题是 Jest 的运行速度会有所降低。</p>","frontmatter":{"title":"Jest with Ant Design","category":"JavaScript","date":"2019-07-29"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"time":"2019-07-29","title":"Jest with Ant Design","previous":{"time":"2019-07-28","title":"SSH Host Config"},"next":{"time":"2019-07-30","title":"Bad owner or permissions"}}}}